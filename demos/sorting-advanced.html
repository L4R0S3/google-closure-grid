<!DOCTYPE html>
<html>
<head>
  <title>Google Closure Grid - pear.ui.Grid</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../lib/font-awesome-4.0.3/css/font-awesome.min.css" />
  <link rel="stylesheet" href="../lib/closure-library/closure/goog/demos/css/demo.css" />

  
  <link rel="stylesheet" href="../src/css/grid.css" />
  
 
 <style>
  body {
  background-color: white;
  font: normal 10pt Arial, sans-serif;
  }

 </style>
  <script src="../lib/closure-library/closure/goog/base.js"></script>
  <script src="../src/bin/release/pear.grid.js"></script>
  <!--<script src="../src/pear/peardeps.js"></script>-->
  <script>
    goog.require('goog.debug.DivConsole');
    goog.require('goog.debug.LogManager');
    goog.require('goog.dom.forms');
    goog.require('pear.ui.Grid');
    goog.require('goog.i18n.NumberFormat')
    goog.require('goog.i18n.DateTimeFormat')
    
  </script>

  <style>
    .config-item{
      display: inline-block;
      padding:2px 3px 2px 8px;
      border-color: gray;
      border-width: 0px 0px 0px 0px;
      border-style: solid;
      margin:0px 2px 0px 2px;
      border-radius:3px;
    }
  </style>
</head>
<body>
   <fieldset class="goog-debug-panel">
    <legend>Advanced Sorting</legend>
    <div id="">
      <li> Sorting is done at DataView level , sort is aware of datatype. </li>
    </div>
  </fieldset>
  <fieldset class="goog-debug-panel">
    <legend>Data / Debug</legend>
    <div id="">
      <div class="config-item"> Console.dir {events} <input type="checkbox" id="id_consoledir" /> </div>
      <div class="config-item"> Nos Of Rows : 
          <select id ="id_rows">
             <option value="10">10</option>
             <option selected value="1000">1000</option>
             <option value="50000">10,000</option>
           </select> 
        </div>
    </div>
  </fieldset>
 
  <fieldset class="goog-debug-panel">
    <legend>Action</legend>
    <div id="">
    <input class="config-item" type="button" id="id_reload" value="Reload"  />
  </fieldset>
  <br>
  <!-- This div will have a Sample Component added to its contents. -->
  <div id="target1" style="width:800px;height:500px">
  </div>
  <fieldset class="goog-debug-panel">
    <legend>Event Log</legend>
    <div id="log"></div>
  </fieldset>
  <div id="perf"></div>
</body>

 <script>

    var timer = goog.now();

    // Set up a logger.
    goog.debug.LogManager.getRoot().setLevel(goog.log.Level.ALL);
    var logger = goog.log.getLogger('demo');
    var logconsole = new goog.debug.DivConsole(goog.dom.getElement('log'));
    logconsole.setCapturing(true);

    var EVENTS2 = goog.object.getValues(pear.ui.Grid.EventType);
    var EVENTS3 = goog.object.getValues(pear.data.DataView.EventType);
    goog.log.fine(logger, 'Listening for: ' + EVENTS2.join(', ') +' , '+EVENTS3.join(', ') + '.');

    function logEvent(e) {
      var component = e.target;
     // var caption = (typeof component.getCaption == 'function') ?
     //     component.getCaption() : component.getId();
      logger.info(' dispatched: ' + e.type);
      if (isChecked('id_consoledir')){
        console.dir(e);
      }
    }

  function isChecked(id,name){
    var elem = goog.dom.getElement(id);
    return  elem.checked;
  };


  function SortedDataView (datacolumns,datarows) {
    pear.data.DataView.call(this,datacolumns,datarows);
  };
  goog.inherits(SortedDataView, pear.data.DataView);

  var prevSortColumn = null;

  SortedDataView.prototype.handleSort = function (ge){
    var headerCell = ge.sortCell;
    var grid = ge.target;
    var sortDirection =ge.sortDirection;
    setSortIndicators(prevSortColumn);

    var sortedData = this.sort_(headerCell,headerCell.getColumnId(),ge.sortDirection);

    setSortIndicators(headerCell,sortDirection);
    prevSortColumn = headerCell;

    this.setDataRowViews(sortedData);
  };

  SortedDataView.prototype.sort_ = function(sortCell,sortField,sortDirection) {
    var rv = this.dataRowViews_;
    var sortFn = function (column){
      
      var fn;
      if (column.datatype === "number"){
        fn=goog.partial(this.numberCompare,sortField,sortDirection);
      }else if (column.datatype === "datetime"){
        fn=goog.partial(this.dateCompare,sortField,sortDirection);
      }else if (column.datatype === "booleam"){
        fn=goog.partial(this.defaultCompare,sortField,sortDirection);
      }else{
        fn=goog.partial(this.defaultCompare,sortField,sortDirection);
      } 

      return fn;
    };
    
    return rv.sort(sortFn.call(this,sortCell.getCellData()));
    
  };


  SortedDataView.prototype.defaultCompare = function(sortfield,sortDirection,value1,value2) {
    
    if (sortDirection === 1){
      temp = value1;
      value1=value2;
      value2 = temp;
    }
    if (value1[sortfield]>value2[sortfield]){
      return 1;
    }

    if (value1[sortfield]<value2[sortfield]){
      return -1;
    }

    return 0;
  };

  SortedDataView.prototype.numberCompare = function(sortfield,sortDirection,value1,value2) {
    if (sortDirection === 1){
      temp = value1;
      value1=value2;
      value2 = temp;
    }
    return value1[sortfield] - value2[sortfield];
  };

  SortedDataView.prototype.dateCompare = function(sortfield,sortDirection,value1,value2) {
    
    if (sortDirection === 1){
      temp = value1;
      value1=value2;
      value2 = temp;
    }
    var dateA=new Date(value1[sortfield]), dateB=new Date(value2[sortfield]);
    return dateA-dateB; //sort by date ascending
  };




  var item = ['Xbox','Kindle DX','Kindle Fire','iPhone','Galaxy S3','Galaxy S4','Google Chromecast','PS3','Apple TV','Wii-u'];
  var unitprice = [179.89,199.00,150.00,699.00,499.00,399.00,34.95,209.80,95.00,234.99];

  var grid;
  var columns = [
    { 
      id: "orderno",
      headerText: "Order No",
      width:75,
      datatype:pear.data.DataTable.DataType.NUMBER
    },
    {
      id: "item",
      headerText: "Item",
      width:75,
      datatype:pear.data.DataTable.DataType.TEXT
    },
    {
      id: "unitprice",
      headerText: "Unit Price",
      width:75,
      datatype:pear.data.DataTable.DataType.NUMBER
    },
    {
      id: "quantity", 
      headerText: "Quantity",
      datatype:pear.data.DataTable.DataType.NUMBER
    },
    {
      id: "total",
      headerText: "Total",
      datatype:pear.data.DataTable.DataType.NUMBER
    },
    {
      id: "created",
      headerText: "Created On",
      datatype:pear.data.DataTable.DataType.DATETIME,
      formatter:dateFormatter
     },
    {
      id: "processed",
      headerText: "Processed",
      datatype:pear.data.DataTable.DataType.BOOLEAN
    }
  ];

  var load = function () {
    if (grid){
      grid.dispose();
    }
    var data = [];
    var limit = goog.dom.forms.getValue(goog.dom.getElement('id_rows'));
    var temp;
    var start = new Date(2013,12,31);
    for (var i = 0; i < parseInt(limit,10); i++) {
      data[i] = {
        orderno:  i+1 
      };
      temp = Math.round(Math.random() * 9);
     
      data[i].item = item[temp];
      data[i].unitprice = unitprice[temp];
      data[i].quantity = Math.round(Math.random() * 100);
      data[i].total = data[i].unitprice * data[i].quantity;
      data[i].processed= (i % 5 === 0);
      data[i].created = new Date(new Date().setDate(new Date().getDate()-Math.round(Math.random() * 365)));
    }

    var start = +new Date();  // log start timestamp


    grid = new pear.ui.Grid();
    var config = {
      AllowPaging:false,
      AllowSorting:true,
      AllowColumnResize:true,
      AllowColumnHeaderMenu: false
    };
    config = grid.setConfiguration(config);

    grid.setWidth(800);
    grid.setHeight(400);
    grid.setDataView( new SortedDataView(columns,data))
    
    goog.events.listen(grid, pear.ui.Grid.EventType.HEADERCELL_RENDERED, createSortIndicators);

    goog.events.listen(grid, EVENTS2, logEvent);
    goog.events.listen(grid.getDataView(), EVENTS3, logEvent);

    grid.render(goog.dom.getElement('target1'));

    var end =  +new Date();  
    var diff = end - start;
    //console.log('Load Time : '+diff+'ms');
    
    goog.events.listen(grid, EVENTS2, logEvent);
    goog.events.listen(grid.getDataView(), EVENTS3, logEvent);

    goog.events.listen(grid, pear.ui.Grid.EventType.SORT, grid.getDataView().handleSort ,false ,grid.getDataView());
    goog.events.listen(grid.getDataView(), pear.data.DataView.EventType.ROWVIEWS_CHANGED, handleRowViewsChanged);
  };

  var setSortIndicators = function (headerCell,sortDirection){
    if (!headerCell) return;
    
    var sortNode = goog.dom.getElementByClass('pear-grid-cell-header-sort',headerCell.getContentIndicatorElement());
    var elAsc = goog.dom.getElementByClass('fa-arrow-circle-down',sortNode);
    var elDesc = goog.dom.getElementByClass('fa-arrow-circle-up',sortNode);
    goog.style.showElement(elAsc,false);
    goog.style.showElement(elDesc,false);

    if (sortDirection === pear.ui.Grid.SortDirection.ASC){
      goog.style.showElement(elAsc,true);
    }else if (sortDirection === pear.ui.Grid.SortDirection.DESC){
      goog.style.showElement(elDesc,true);
    }
  };

  var createSortIndicators = function(ge){
    var grid = ge.target;
    var headerCell = ge.cell;
    var contentIndicatorElem = headerCell.getContentIndicatorElement();

    sortIndicator = goog.dom.createDom('div',
                                            'pear-grid-cell-header-sort'
                                          );
    goog.dom.appendChild(contentIndicatorElem, sortIndicator);

    sortNode = goog.dom.createDom('div',{class : 'fa fa-arrow-circle-down' ,style:'display:none' });
    goog.dom.appendChild(sortIndicator,sortNode);
    sortNode = goog.dom.createDom('div',{class : 'fa fa-arrow-circle-up' ,style:'display:none' });
    goog.dom.appendChild(sortIndicator,sortNode);
  };


  function dateFormatter(val){
    var fmt = new goog.i18n.DateTimeFormat (goog.i18n.DateTimeFormat.Format.SHORT_DATE);
    return fmt.format(val);
  };

  var handleRowViewsChanged = function (ge){
    var dv = ge.target;
    var grid = dv.getGrid();
    grid.setDataRows(dv.getDataRowViews());
    grid.refresh();
  }


  goog.events.listen(goog.dom.getElement('id_reload'), goog.events.EventType.CLICK, load);

 </script>

</html>
